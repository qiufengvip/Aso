<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>发送帖子</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.css">
		<link rel="stylesheet" type="text/css" href="css/uploadpost.css" />
		<script src="../js/mui.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/qsub_video.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../css/video.css" />
		<script src="js/addphotos.js" type="text/javascript" charset="utf-8"></script>
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/HttpRequest.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/jquery.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<!-- <h1 class="mui-title">发送动态</h1> -->
			<button type="button" id="publish" class="mui-btn mui-pull-right">发表</button>
		</header>

		<div class="mui-content" id="">
			<textarea id="textarea" rows="5" placeholder="快来分享你的快乐吧!"></textarea>
			<div class="" id="">
				<div class="imgpage" id="">


					<div class="select" id="">
						<svg t="1610698728893" class="iconss" viewBox="0 0 1027 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
						 p-id="2527" width="40" height="40">
							<path d="M984.191664 461.608438h-428.184484v-415.402859c0-19.17244-19.17244-44.735692-44.735693-44.735692-25.563253 0-44.735692 25.563253-44.735692 51.126506v415.402858H51.132936c-25.563253-6.390813-51.126506 19.17244-51.126505 44.735693s25.563253 44.735692 44.735692 44.735692h415.402859v415.402858c6.390813 25.563253 25.563253 51.126506 51.126505 51.126506s44.735692-25.563253 44.735693-44.735692v-421.793672h421.793671c25.563253 0 44.735692-25.563253 44.735693-44.735692s-12.781626-51.126506-38.34488-51.126506z"
							 fill="#9c9c9c" p-id="2528"></path>
							</viewBoxsvg>
					</div>
				</div>
			</div>
			
			
			<div class="circle" > 
				<div class="circle-left">
					<svg t="1610779090763" class="iconaaa" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2572"><path d="M590.72037761 364.42670295c0 43.77082241 35.48103787 79.25086187 79.25086291 79.25086293s79.24986453-35.48003947 79.24986454-79.25086293c0-43.76982507-35.48003947-79.24986453-79.24986454-79.24986454-43.76982507 0-79.25086187 35.48003947-79.25086293 79.24986454z" fill="#6964FF" p-id="2573"></path><path d="M511.47051308 364.42670295c23.77076907 0 39.62393493-15.8491744 39.62393492-39.62493228 0-23.7767552-15.85316587-39.62493226-39.62393492-39.62493226-130.76766508 0-237.75757653 106.98991148-237.75757548 237.75757654 0 130.76068052 106.98991148 237.750592 237.75757548 237.750592 130.76068052 0 237.750592-106.98991148 237.75059198-237.7515904 0-23.7767552-15.84817708-39.62992107-39.62393493-39.62992108-23.7777536 0-39.6259296 15.85316587-39.62592961 39.62992108 0 87.17245652-71.32926827 158.5017248-158.50172479 158.50172479-87.17744533 0-158.5067136-71.32926827-158.5067136-158.50172479 0-87.17844266 71.32926827-158.5067136 158.50771093-158.5067136z" fill="#6964FF" p-id="2574"></path><path d="M511.47051308 47.41926294c-83.215152 0-166.4342944 23.77575787-237.75757548 63.40068906-19.81346346 11.88688107-23.7777536 35.66263893-15.85017279 55.47510507 11.88688107 19.81346346 35.66164053 23.7767552 55.47610239 11.89087253 59.4373984-31.70333867 126.80138028-51.5158048 198.13164586-51.51580481 217.9391232 0 396.25830293 178.3181824 396.258304 396.26329174 0 217.9391232-178.31917973 396.25930133-396.25930133 396.25930134-217.944112 0-396.2622944-178.32017813-396.26229441-396.25930134 0-71.32926827 19.8114688-138.69325012 51.51580481-198.13164586 11.88488533-19.81346346 3.96329172-43.588224-11.89187093-55.47510401-15.84817708-11.88987413-43.5872256-3.96329172-55.47410667 15.85017173-39.6259296 71.32328213-63.40069013 154.54242453-63.40069012 237.75757654 0 261.5273472 213.97982293 475.50717013 475.51415465 475.50717013 261.5273472 0 475.50816747-213.97982293 475.50816853-475.50816853 0-261.53333333-213.97982293-475.51415467-475.50816853-475.51415359z" fill="#6964FF" p-id="2575"></path></svg>
				</div>
				<div class="qsub-fakeinput" id="setcircle">
					圈子
				</div>
			</div>

		</div>




		<script type="text/javascript">
			mui.init();
			//总容器
			var imgpage = document.getElementsByClassName("imgpage")[0];
			//底部加号
			var vcurrent = document.getElementsByClassName("select")[0];
			
			//circle id  选择完毕的圈子id
			var circleid = -1;


			// var doc_controls = document.createElement("div");
			// doc_controls.className = "video-data"
			// document.getElementById("video-data-boy").appendChild(doc_controls);
			// new_qsub_video(doc_controls, "http://file.qsub.cn/1024.mp4");

			// //在什么之上添加
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);
			// vcurrent.parentNode.insertBefore(addphotos("img/x18.png", 1), vcurrent);

			//获取元素的个数
			// console.log(imgpage.getElementsByClassName("upload-img").length)
			
			
			//圈子选择
			//普通示例2 -----------------------------
			
			
			mui.plusReady(function() {
			    setcircle();  //加载圈子信息
			});
			
			
			
			function setcircle(){
				console.log("进入圈子");
				var userPicker = new mui.PopPicker();
				//到时候学校这个框 动态加载
				userPicker.setData([{
					value: 1,
					text: '请选择圈子'
				}]);
				
				httpPost(url_issue_circle, {}, function(data) {
					if (data != undefined) {
						console.log(data.data)
						userPicker.setData(data.data);
					} else {
						mui.toast("网络异常");
					}
				});
				
				
				
				var showUserPickerButton = document.getElementById('setcircle');
				showUserPickerButton.addEventListener('tap', function(event) {
					userPicker.show(function(items) {
						//添加到列表
						showUserPickerButton.innerText = items[0].text;
						circleid = items[0].value;
						console.log(circleid)
						//返回 false 可以阻止选择框的关闭
						//return false;
					});
				}, false);
			}
			
			
			
			document.getElementById("publish").addEventListener('tap',function(){
				if(circleid<0){
					mui.toast("请选择圈子");
				}else{
					//一切都没问题了
					
					var data = {};
					data.placaid = circleid;
					var textarea  = document.getElementById("textarea").value;
					if(isnull(textarea)){
						data.content = textarea;
						// mui.toast(textarea)
					}
					//图片
					var imgfew = imgpage.getElementsByClassName("upload-img").length;
					console.log(imgfew)
					
					if(imgfew>0){
						var imgarray = new Array();
						$("div[class=imgpage] img").each(function() {   
						    var src=$(this).attr("src");
							imgarray.push(src);
						});
						data.image = imgarray
					}else{
						var videofew = imgpage.getElementsByClassName("video-data").length;
						if(videofew>0){
							$("div[class=imgpage] video").each(function() {
							    var src=$(this).attr("src");
								data.video = src
							});
							
						}
					}
					
					
					console.log(JSON.stringify(data))
					
					//跨窗口通讯  开始   
					//获取主窗口
					var preView = plus.webview.getWebviewById('hot');
					//调用自定义事件
					mui.fire(preView, 'updatedynamic',data);
					mui.back();
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
				}
				
			});
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			//视频数据到网页 http://file.qsub.cn/1024.mp4
			function videoToHTML(videourl) {
				var doc_videodata = document.createElement("div");
				doc_videodata.className = "video-data"
				
				var doc_svg = document.createElement("div");
				doc_svg.className = "icon";
				doc_svg.innerHTML = vidoedele
				
				var doc_controls = document.createElement("div");
				doc_controls.className = "qsub-ands-video"
				new_qsub_video(doc_controls, videourl);
				
				doc_videodata.appendChild(doc_svg);
				doc_videodata.appendChild(doc_controls);
				vcurrent.parentNode.insertBefore(doc_videodata, vcurrent);
				document.getElementsByClassName("select")[0].style.display = "none";
				doc_svg.addEventListener('tap', function() { 
					console.log("------")
					document.getElementsByClassName("imgpage")[0].removeChild(doc_videodata);
					//添加按钮可视
					document.getElementsByClassName("select")[0].style.display = "flex";
				});
				
				
			}

			// videoToHTML("http://file.qsub.cn/1024.mp4")




			//加入图片
			function pushimg(ingurl) {
				var imgfew = imgpage.getElementsByClassName("upload-img").length;
				var videofew = imgpage.getElementsByClassName("video-data").length;
				//移除所有视频
				if (videofew != 0) {
					for (var i = 0; i < videofew; i++) {
						imgpage.removeChild(imgpage.getElementsByClassName("video-data")[0]);
					}
				}
				//加入图片
				if (imgfew < 8) {
					vcurrent.parentNode.insertBefore(addphotos(ingurl), vcurrent);
				} else if (imgfew == 8) {
					vcurrent.parentNode.insertBefore(addphotos(ingurl), vcurrent);
					vcurrent.style.display = "none";
				} else {
					mui.toast("最多添加九张图片哦");
				}
			}


			//加入视频
			function pushvideo(videourl) {
				//图片数量
				var imgfew = imgpage.getElementsByClassName("upload-img").length;
				//视频数量
				var videofew = imgpage.getElementsByClassName("video-data").length;
				//移除所有
				for (var i = 0; i < imgfew; i++) {
					imgpage.removeChild(imgpage.getElementsByClassName("upload-img")[0]);
				}
				//移除所有
				for (var i = 0; i < videofew; i++) {
					imgpage.removeChild(imgpage.getElementsByClassName("video-data")[0]);
				}
				videoToHTML(videourl);
			}








			document.getElementsByClassName('select')[0].addEventListener('tap', function() {
				if (mui.os.plus) {
					var a = [{
							title: "拍照"
						},
						{
							title: "拍摄视频"
						},
						{
							title: "从手机相册选择图片"
						},
						{
							title: "从手机相册选择视频"
						}
					];
					plus.nativeUI.actionSheet({
						title: "上传文件",
						cancel: "取消",
						buttons: a
					}, function(b) { /*actionSheet 按钮点击事件*/
						switch (b.index) {
							case 0:
								break;
							case 1:
								getImage(); /*拍照*/
								break;
							case 3:
								galleryImg(); /*打开相册*/
								break;
							case 2:
								galleryVideo(); /*视频*/
								break;
							case 4:
								gatVideo(); /*相册选择视频*/
								break;
							default:
								break;
						}
					})
				}
			}, false);

			// 获取  拍照图片
			function getImage() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var imgSrc = entry.toLocalURL() + "?version=" + new Date().getTime(); //拿到图片路径  
						// upLoadFile(imgSrc, 'image');
						pushimg(imgSrc);
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
				}, function(s) {
					console.log("error" + s.message);
				}, {
					filename: "_doc/camera/"
				})
			}



			// 获取拍照视频
			function galleryVideo() {
				var cam = plus.camera.getCamera();
				cam.startVideoCapture(function(t) {
					plus.io.resolveLocalFileSystemURL(t, function(entry) {
						var videoSrc = entry.toLocalURL() + "?version=" + new Date().getTime(); //拿到视频路径  
						// setHtmlVideo(videoSrc);
						console.log(videoSrc);
						pushvideo(videoSrc);
						// upLoadFile(videoSrc, 'video');
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
				}, function(e) {

				}, {
					filename: '_downloads/video/', //录像文件保存的路径
					format: cam.supportedVideoFormats[0], //摄像的文件格式
					index: 1, //摄像默认使用的摄像头
					videoMaximumDuration: 10, //视频长度
					resolution: cam.supportedVideoResolutions[0], //摄像使用的分辨率
					popover: { //摄像界面弹出指定区域
						top: "10px",
						left: "10px",
						width: "200px",
						height: "200px"
					}
				})
			}

			//gatVideo  相册获取视频

			function gatVideo() {
				console.log("开始");
				plus.gallery.pick(function(e) {
					var fileSrc = e.files[0];
					console.log(fileSrc);
					pushvideo(fileSrc);
				}, function(e) {
					console.log("取消选择视频");
				}, {
					filter: "video",
					multiple: true,
					maximum: 1,
					system: false,
					onmaxed: function() {
						plus.nativeUI.alert('最多只能选择1个视频');
					}
				});
			}



			//获取相册图片
			function galleryImg() {
				console.log("开始");
				//已存在图片数量
				var imgfew = imgpage.getElementsByClassName("upload-img").length;
				var neblt = 0;
				if(imgfew<9){
					neblt = 9-imgfew;
				}else{
					mui.toast("最多选择9张图片");
					return;
				}
				



				plus.gallery.pick(function(e) {
				
					for (var i in e.files) {
						var fileSrc = e.files[i];
						//遍历选择完成的图片
						// upLoadFile(fileSrc, 'image');
						console.log(fileSrc);
						pushimg(fileSrc)
					}
				}, function(e) {
					console.log("取消选择图片");
				}, {
					filter: "image",
					multiple: true,
					maximum: neblt,
					system: false,
					onmaxed: function() {
						plus.nativeUI.alert('最多只能再选择'+neblt+'张图片');
					}
				});
			}


			var fileData = [];
			var i = 0;


			function upLoadFile(fileSrc, type) {
				i++;
				var wt = plus.nativeUI.showWaiting();
				var upload_api = baseUrl + '/dfs/mongodb/file/upload'
				var task = plus.uploader.createUpload(upload_api, {
						method: "POST"
					},
					function(t, status) { //上传成功服务器返回文件对象
						if (status == 200) {
							// mui.alert("上传成功！" + t.responseText);
							var objData = JSON.parse(t.responseText)
							var obj = [{
								type: type,
								uid: objData[0].id,
								name: objData[0].name ? objData[0].name : 'uploadFile' + i,
								url: objData[0].path,
								size: objData[0].size,
								duartion: 0,
								status: 'done'
							}];
							fileData = fileData.concat(obj);
							wt.close(); //关闭等待提示按钮
						} else {
							mui.alert("上传失败：" + status);
							wt.close(); //关闭等待提示按钮
						}
					}
				);
				task.setRequestHeader('token', localStorage.getItem('access_token'));
				task.addData("sysChannel", '');
				task.addData("applyId", '');
				task.addFile(fileSrc, {
					key: "file"
				});
				task.start();
			}
		</script>




	</body>
</html>
